#!/bin/bash
# WiFi module reload hook for hibernation
# Fixes rtw89_8852ce driver timeout on resume (error -110)
#
# This script unloads the WiFi driver before hibernation and reloads it after resume
# to work around the Realtek RTL8852CE driver's poor hibernation support.
#
# Location: /usr/lib/systemd/system-sleep/wifi-hibernate-fix

WIFI_MODULES="rtw89_8852ce rtw89_pci rtw89_core"

case "$1/$2" in
  pre/hibernate)
    echo "WiFi Fix: Unloading WiFi modules before hibernation..."
    for module in $WIFI_MODULES; do
      if lsmod | grep -q "^$module"; then
        modprobe -r "$module" 2>/dev/null
        echo "  - Unloaded: $module"
      fi
    done
    ;;
  post/hibernate)
    echo "WiFi Fix: Reloading WiFi modules after hibernation..."
    # Wait a moment for system to stabilize
    sleep 2
    for module in $WIFI_MODULES; do
      modprobe "$module" 2>/dev/null && echo "  - Loaded: $module"
    done
    # Give NetworkManager time to detect the interface
    sleep 1
    ;;
esac
